<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control Panel - Pipah Cookies</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
  /* --- ORIGINAL STYLES FROM INDEX.HTML (Preserved for 1:1 Look) --- */
  :root{
    --primary:#A67734;
    --primary-dark:#d4b390;
    --accent:#fff1e6;
    --whatsapp:#25d366;
    --bg:#fff8f2;
    --card:#ffffff;
    --muted:#6b6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Fredoka",sans-serif;background:var(--bg);color:#222;-webkit-font-smoothing:antialiased}
  h1,h2,h3{font-family:"Poppins",sans-serif;color:var(--primary-dark);margin:0 0 8px}
  
  /* Header */
  .site-header{display:block; position: relative;}
  .header-img{width:100%;height:auto;display:block;object-fit:cover;max-height:360px;border-radius:0 0 14px 14px;box-shadow:0 8px 18px rgba(0,0,0,0.06);}

  /* Product Grid */
  .product-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 18px;
    max-width: 1100px;
    margin: 12px auto;
  }
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 12px 24px rgba(0,0,0,0.06);transition:transform .18s; position: relative;}
  .product-card {
    flex: 0 0 300px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .product-img{width:100%;height:160px;object-fit:cover;border-radius:8px; cursor: pointer;}
  .price{color:var(--primary-dark);font-weight:700;margin-bottom:6px; font-size: 1.2rem;}

  /* Inputs & Buttons */
  .btn{display:inline-block;padding:10px 14px;border-radius:22px;border:none;cursor:pointer;font-weight:800;}
  .btn.primary{background:var(--primary);color:#fff}
  
  /* --- ADMIN PANEL SPECIFIC STYLES --- */
  .admin-toolbar {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 1000;
    display: flex;
    gap: 10px;
    align-items: center;
    border: 1px solid var(--primary);
  }

  .editable {
    border: 2px dashed #ccc;
    padding: 2px;
    min-height: 1em;
    cursor: text;
    transition: border-color 0.2s;
  }
  .editable:focus {
    border-color: var(--primary);
    background: #fffdf9;
    outline: none;
  }

  .edit-overlay {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255,255,255,0.8);
    padding: 5px;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .img-edit-wrap {
    position: relative;
    cursor: pointer;
  }
  .img-edit-wrap:hover::after {
    content: "ðŸ“· Change Image";
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.5);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    border-radius: 8px;
  }

  .stock-toggle {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
  }

  .delete-btn {
    background: #ff4d4d;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 5px;
    font-size: 12px;
  }
  
  .add-product-card {
    border: 3px dashed #ccc;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 50px;
    color: #ccc;
    cursor: pointer;
  }
  .add-product-card:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  /* Status Toast */
  #status-toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: #fff;
    padding: 10px 20px;
    border-radius: 20px;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 2000;
  }
  #status-toast.show { opacity: 1; }
  </style>
</head>
<body>

  <!-- Status Message -->
  <div id="status-toast">Saved!</div>

  <!-- Admin Toolbar -->
  <div class="admin-toolbar">
    <div>
        <strong>Control Panel</strong><br>
        <small style="color:var(--muted)">Edit content & Save</small>
    </div>
    <button class="btn primary" onclick="saveAllChanges()">ðŸ’¾ SAVE CHANGES</button>
  </div>

  <header class="site-header">
    <div class="img-edit-wrap" onclick="triggerImageUpload('header-img')">
        <img src="Images/headerrr.png" alt="Pipah Cookies" class="header-img" id="header-img">
    </div>
  </header>

  <main style="padding: 20px;">
    
    <!-- About Section Editing -->
    <section class="section">
        <h2>ðŸ“¢ Announcements / Intro</h2>
        <div id="announcement-text" class="editable" contenteditable="true">
            Loading text...
        </div>
    </section>

    <!-- Product Management -->
    <section id="products" class="section">
      <h2>Edit Products</h2>
      <p style="color:var(--muted); font-size: 0.9em;">Click text to edit. Click image to upload. Toggle stock status.</p>

      <div class="product-grid" id="admin-product-grid">
        <!-- Products will be injected here via JS -->
      </div>
    </section>

  </main>

  <!-- Hidden File Input for Image Uploads -->
  <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">

<script>
// --- CONFIGURATION ---
// Important: Accessing provided variables from the environment
const firebaseConfig = {
  apiKey: "AIzaSyB1zNzsKmXXLVsOVGnVeGwlT_0uX3XqdO0",
  authDomain: "pipahcookies-order.firebaseapp.com",
  databaseURL: "https://pipahcookies-order-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "pipahcookies-order",
  storageBucket: "pipahcookies-order.firebasestorage.app",
  messagingSenderId: "1038900448087",
  appId: "1:1038900448087:web:a46586f21e9ae989708c12"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentEditingImageId = null;
let productsData = [];

// --- AUTHENTICATION ---
auth.signInAnonymously().catch((error) => {
  console.error("Auth Error:", error);
  showToast("Error logging in: " + error.message);
});

// --- LOAD DATA ---
auth.onAuthStateChanged((user) => {
  if (user) {
    loadSiteContent();
    loadProducts();
  }
});

function loadSiteContent() {
    db.collection('site_content').doc('main').get().then((doc) => {
        if (doc.exists) {
            const data = doc.data();
            if(data.announcement) document.getElementById('announcement-text').innerText = data.announcement;
            if(data.headerImg) document.getElementById('header-img').src = data.headerImg;
        } else {
             document.getElementById('announcement-text').innerText = "Welcome to Pipah Cookies! Click here to edit this text.";
        }
    });
}

function loadProducts() {
    db.collection('products').orderBy('order').get().then((snapshot) => {
        const grid = document.getElementById('admin-product-grid');
        grid.innerHTML = '';
        productsData = [];

        if (snapshot.empty) {
            // SEED DATA if empty (First run)
            seedInitialData();
            return;
        }

        snapshot.forEach((doc) => {
            const p = doc.data();
            p.docId = doc.id; // Store Firestore ID
            productsData.push(p);
            grid.appendChild(createProductCard(p));
        });

        // Add "Add Product" button at the end
        const addBtn = document.createElement('div');
        addBtn.className = 'product-card add-product-card';
        addBtn.innerHTML = '+';
        addBtn.onclick = addNewProduct;
        grid.appendChild(addBtn);
    });
}

// --- RENDERING ---
function createProductCard(data) {
    const div = document.createElement('article');
    div.className = 'card product-card';
    div.id = `card-${data.docId}`;
    
    // Determine Image Source (Fallback to placeholder if missing)
    const imgSrc = data.mediaUrl || 'https://placehold.co/300x200?text=No+Image';

    div.innerHTML = `
        <div class="img-edit-wrap" onclick="triggerImageUpload('${data.docId}')">
            <img src="${imgSrc}" class="product-img" id="img-${data.docId}">
        </div>
        
        <div style="margin-top:10px;">
            <label style="font-size:12px; color:#888;">Name:</label>
            <h3 class="editable" contenteditable="true" id="name-${data.docId}">${data.name}</h3>
        </div>

        <div>
            <label style="font-size:12px; color:#888;">Price (RM):</label>
            <div class="price editable" contenteditable="true" id="price-${data.docId}">${data.price}</div>
        </div>

        <div class="stock-toggle">
            <input type="checkbox" id="stock-${data.docId}" ${data.stock > 0 ? 'checked' : ''}>
            <label for="stock-${data.docId}">In Stock</label>
        </div>
        
        <div style="margin-top:5px;">
             <label style="font-size:12px; color:#888;">Video URL (Optional):</label>
             <div class="editable" style="font-size:11px; overflow:hidden;" contenteditable="true" id="video-${data.docId}">${data.videoUrl || ''}</div>
        </div>

        <button class="delete-btn" onclick="deleteProduct('${data.docId}')">Delete Product</button>
    `;
    return div;
}

// --- ACTIONS ---

function addNewProduct() {
    const newProduct = {
        name: "New Product",
        price: 10.00,
        stock: 10,
        mediaUrl: "",
        order: Date.now() // Simple ordering
    };
    
    db.collection('products').add(newProduct).then(() => {
        loadProducts();
        showToast("New product added!");
    });
}

function deleteProduct(docId) {
    if(confirm("Are you sure you want to delete this product?")) {
        db.collection('products').doc(docId).delete().then(() => {
            document.getElementById(`card-${docId}`).remove();
            showToast("Product deleted");
        });
    }
}

// --- IMAGE UPLOAD HANDLING ---
function triggerImageUpload(targetId) {
    currentEditingImageId = targetId;
    document.getElementById('file-input').click();
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Limit size to prevent Firestore issues (Max 500KB for this demo approach)
    if (file.size > 500000) {
        alert("File too large! Please choose an image under 500KB.");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const base64 = e.target.result;
        
        // Update UI immediately
        if (currentEditingImageId === 'header-img') {
            document.getElementById('header-img').src = base64;
        } else {
            document.getElementById(`img-${currentEditingImageId}`).src = base64;
        }
        
        // Flag that we have a new image to save for this ID
        // In a real app, upload to Storage here. For this, we save Base64 to Firestore directly.
        document.getElementById(currentEditingImageId === 'header-img' ? 'header-img' : `img-${currentEditingImageId}`).dataset.newImage = base64;
    };
    reader.readAsDataURL(file);
}

// --- SAVING ---
function saveAllChanges() {
    const batch = db.batch();
    
    // 1. Save Site Content
    const headerImgEl = document.getElementById('header-img');
    const headerNewSrc = headerImgEl.dataset.newImage || headerImgEl.src;
    
    const siteRef = db.collection('site_content').doc('main');
    batch.set(siteRef, {
        announcement: document.getElementById('announcement-text').innerText,
        headerImg: headerNewSrc
    }, { merge: true });

    // 2. Save Products
    productsData.forEach(p => {
        const docRef = db.collection('products').doc(p.docId);
        const name = document.getElementById(`name-${p.docId}`).innerText;
        const price = parseFloat(document.getElementById(`price-${p.docId}`).innerText);
        const stock = document.getElementById(`stock-${p.docId}`).checked ? 10 : 0;
        const videoUrl = document.getElementById(`video-${p.docId}`).innerText;
        
        // Check if image changed
        const imgEl = document.getElementById(`img-${p.docId}`);
        const mediaUrl = imgEl.dataset.newImage || p.mediaUrl || imgEl.src;

        batch.update(docRef, {
            name: name,
            price: price,
            stock: stock,
            mediaUrl: mediaUrl,
            videoUrl: videoUrl
        });
    });

    batch.commit().then(() => {
        showToast("All changes saved successfully!");
        // Clear new image flags
        document.querySelectorAll('img').forEach(img => delete img.dataset.newImage);
    }).catch(err => {
        console.error(err);
        alert("Error saving: " + err.message);
    });
}

// --- SEEDING (One time migration) ---
function seedInitialData() {
    // Data from your old products.js
    const initialProducts = [
        { id: 1, name: 'Japanese Crmpuff 15pcs', price: 10.00, stock: 10, mediaUrl: 'Images/jc1.jpg', order: 1 }, 
        { id: 2, name: 'Roti Golok', price: 5.50, stock: 10, mediaUrl: 'Images/item2.jpg', order: 2 }, 
        { id: 3, name: 'Seasalt Cookies 65pcs', price: 16.00, stock: 20, mediaUrl: 'Images/ss1.jpg', order: 3 },
        { id: 4, name: 'Osaka Crmpuff 20pcs', price: 10.00, stock: 10, mediaUrl: 'Images/oc1.jpg', order: 4 },
        { id: 5, name: 'Black Cookies(80pcs)', price: 19.00, stock: 20, mediaUrl: 'Images/bc5.jpg', order: 5 },
        { id: 6, name: 'Kek Choc Moist 4`', price: 10.00, stock: 10, mediaUrl: 'Images/cm1.jpg', order: 6 }
    ];

    const batch = db.batch();
    initialProducts.forEach(p => {
        const ref = db.collection('products').doc(); // Auto ID
        batch.set(ref, p);
    });

    batch.commit().then(() => {
        loadProducts(); // Reload to show seeded data
    });
}

function showToast(msg) {
    const t = document.getElementById('status-toast');
    t.innerText = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}
</script>
</body>
</html>

