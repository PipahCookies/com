<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#A67734">
  <title>Admin Panel ‚Äî PipahCookies</title>
  
  <link rel="apple-touch-icon" href="Images/icon.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #A67734;       
      --primary-dark: #8b5e2b;  
      --bg-color: #f4f7f6;      
      --sidebar-bg: #ffffff;
      --text-main: #333;
      --text-muted: #888;
      --success: #2ecc71;
      --danger: #e74c3c;
      --radius: 12px;
      --shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

    body {
      margin: 0; font-family: 'Poppins', sans-serif;
      background: var(--bg-color); color: var(--text-main);
      display: flex; min-height: 100vh;
      transition: background 0.3s;
    }

    /* --- Sidebar --- */
    .sidebar {
      width: 250px; background: var(--sidebar-bg);
      padding: 20px; display: flex; flex-direction: column;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      position: fixed; top: 0; bottom: 0; left: 0; z-index: 100;
      transition: transform 0.3s;
    }
    .brand {
      font-size: 20px; font-weight: 700; color: var(--primary);
      margin-bottom: 40px; display: flex; align-items: center; gap: 10px;
      transition: color 0.3s;
    }
    .nav-link {
      padding: 12px 15px; margin-bottom: 8px;
      border-radius: var(--radius); cursor: pointer;
      color: var(--text-muted); font-weight: 500;
      transition: 0.2s; display: flex; align-items: center; gap: 10px;
    }
    .nav-link:hover, .nav-link.active { background: var(--primary); color: #fff; }

    /* --- Main Content --- */
    .main-content { flex: 1; margin-left: 250px; padding: 30px; width: 100%; }
    
    .page-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
    }
    .page-title { font-size: 24px; font-weight: 600; }
    .menu-toggle { display: none; font-size: 24px; background: none; border: none; cursor: pointer; }

    .view-section { display: none; animation: fadeIn 0.3s; }
    .view-section.active { display: block; }

    /* --- Grid & Cards --- */
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .card {
      background: #fff; border-radius: var(--radius); padding: 20px;
      box-shadow: var(--shadow); position: relative;
    }
    .status-badge { background: #e0f2f1; color: #009688; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    
    /* --- Forms & Uploads --- */
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; }
    .form-input {
      width: 100%; padding: 10px; border: 1px solid #eee;
      border-radius: 8px; font-family: inherit; font-size: 14px;
    }
    .form-input[type="color"] { padding: 0; border: none; height: 40px; width: 100%; cursor: pointer; }

    .file-upload-wrapper {
        border: 2px dashed #ddd; border-radius: 8px; padding: 15px;
        text-align: center; cursor: pointer; transition: 0.2s; position: relative;
        background: #fafafa;
    }
    .file-upload-wrapper:hover { border-color: var(--primary); background: #fffcf8; }
    .file-input-hidden { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    .upload-preview-area {
        margin-top: 10px; height: 100px; background: #eee; border-radius: 6px;
        display: none; align-items: center; justify-content: center; overflow: hidden;
    }
    .upload-preview-area.has-file { display: flex; }
    .upload-preview-area img { max-width: 100%; max-height: 100%; object-fit: contain; }

    .form-section-title {
        font-size: 14px; font-weight: 700; color: var(--primary); 
        margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;
    }

    .btn {
      padding: 10px 20px; border-radius: 8px; border: none;
      cursor: pointer; font-weight: 500; font-size: 14px; transition: 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-danger { background: #ffebee; color: var(--danger); }
    .btn-success { background: var(--success); color: white; }

    /* --- Orders List --- */
    .order-card {
      background: #fff; margin-bottom: 15px; padding: 20px;
      border-radius: var(--radius); box-shadow: var(--shadow);
      display: flex; flex-direction: column; gap: 10px;
      border-left: 4px solid var(--primary);
    }
    .order-header { display: flex; justify-content: space-between; font-weight: 600; }
    .order-items { background: #f9f9f9; padding: 10px; border-radius: 8px; font-size: 13px; }

    /* --- Settings & Tier Styling --- */
    .settings-container { display: flex; flex-direction: column; gap: 20px; max-width: 700px; }
    .settings-group {
      background: #fff; padding: 25px; border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .tier-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
    .tier-row input { flex: 1; }
    .remove-tier { background: #ffebee; color: red; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }

    /* --- Toast & Responsive --- */
    .toast {
      position: fixed; bottom: 20px; right: 20px;
      background: #333; color: #fff; padding: 12px 24px;
      border-radius: 8px; opacity: 0; pointer-events: none;
      transform: translateY(10px); transition: 0.3s; z-index: 1000;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .demo-badge {
        position: fixed; top: 10px; right: 10px; background: orange; color: black;
        padding: 5px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; z-index: 200;
        display: none;
    }

    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); width: 80%; }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0; padding: 20px; }
      .menu-toggle { display: block; color: var(--primary); }
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    .spinner { border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid #fff; width: 16px; height: 16px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="demo-badge" class="demo-badge">DEMO MODE (No Server)</div>

  <aside class="sidebar" id="sidebar">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div class="brand" id="sidebar-brand" style="margin-bottom: 0;">üç™ Pipah<span>Admin</span></div>
        <button onclick="toggleSidebar()" style="background:none; border:none; font-size:24px; color:#999; display: block; padding: 0;">‚úï</button>
    </div>
    <nav>
      <div class="nav-link active" onclick="switchTab('orders'); toggleSidebar();">üì¶ Orders <span id="order-badge" style="background:red; color:white; font-size:10px; padding:2px 6px; border-radius:10px; margin-left:auto;">0</span></div>
      <div class="nav-link" onclick="switchTab('products'); toggleSidebar();">üç™ Products</div>
      <div class="nav-link" onclick="switchTab('feedback'); toggleSidebar();">üí¨ Feedback</div>
      <div class="nav-link" onclick="switchTab('settings'); toggleSidebar();">‚öôÔ∏è Settings & Hero</div>
      </nav>
    <div style="margin-top: auto; font-size: 12px; color: #aaa;">v1.8.0 Panel</div>
  </aside>

  <main class="main-content">
    <header class="page-header">
      <div style="display:flex; align-items:center; gap:15px;">
        <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
        <h1 class="page-title" id="page-title">Orders Management</h1>
      </div>
    </header>

    <section id="orders" class="view-section active">
      <div id="order-list">Loading orders...</div>
    </section>

    <section id="products" class="view-section">
      <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
        <button class="btn btn-primary" onclick="openProductModal()">
            <i class="fas fa-plus"></i> Add New Product
        </button>
      </div>
      <div class="grid-container" id="product-list">
        </div>
    </section>
    
    <section id="feedback" class="view-section">
      <div class="settings-container">
        <div class="settings-group">
            <h3 style="margin-top:0; color:var(--primary);">üí¨ Testimonials & Feedback</h3>
            <p style="font-size:12px; color:#888;">Manage customer reviews and photos shown on the homepage.</p>

            <div class="form-group">
                <label class="form-label">Featured Quote</label>
                <textarea id="set-tst-quote" class="form-input" rows="3" placeholder="e.g. 'Sedap sangat! Biskut paling crunchy...'"></textarea>
            </div>

            <div class="form-section-title">Customer Photos (5 Images)</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
                <div class="form-group">
                    <label class="form-label">Photo 1</label>
                    <div class="file-upload-wrapper" style="padding:10px;">
                        <span style="font-size:10px;">Upload</span>
                        <input type="file" id="tst-file-1" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-tst-1')">
                    </div>
                    <input type="hidden" id="exist-tst-1">
                    <div id="prev-tst-1" class="upload-preview-area" style="height:80px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Photo 2</label>
                    <div class="file-upload-wrapper" style="padding:10px;">
                        <span style="font-size:10px;">Upload</span>
                        <input type="file" id="tst-file-2" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-tst-2')">
                    </div>
                    <input type="hidden" id="exist-tst-2">
                    <div id="prev-tst-2" class="upload-preview-area" style="height:80px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Photo 3</label>
                    <div class="file-upload-wrapper" style="padding:10px;">
                        <span style="font-size:10px;">Upload</span>
                        <input type="file" id="tst-file-3" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-tst-3')">
                    </div>
                    <input type="hidden" id="exist-tst-3">
                    <div id="prev-tst-3" class="upload-preview-area" style="height:80px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Photo 4</label>
                    <div class="file-upload-wrapper" style="padding:10px;">
                        <span style="font-size:10px;">Upload</span>
                        <input type="file" id="tst-file-4" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-tst-4')">
                    </div>
                    <input type="hidden" id="exist-tst-4">
                    <div id="prev-tst-4" class="upload-preview-area" style="height:80px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Photo 5</label>
                    <div class="file-upload-wrapper" style="padding:10px;">
                        <span style="font-size:10px;">Upload</span>
                        <input type="file" id="tst-file-5" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-tst-5')">
                    </div>
                    <input type="hidden" id="exist-tst-5">
                    <div id="prev-tst-5" class="upload-preview-area" style="height:80px;"></div>
                </div>
            </div>
            
            <button class="btn btn-primary" style="width:100%; margin-top:20px;" id="btn-save-feedback" onclick="saveAllSettings()">
                Save Feedback Settings
            </button>
        </div>
      </div>
    </section>

    <section id="settings" class="view-section">
      <div class="settings-container">
        
        <div class="settings-group">
            <h3 style="margin-top:0; color:var(--primary);">üñºÔ∏è Homepage Hero Slider</h3>
            <p style="font-size:12px; color:#888;">Manage the 5 sliding images and text on the home screen.</p>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                <div class="form-group">
                    <label class="form-label">Hero Title</label>
                    <input type="text" id="set-hero-title" class="form-input" placeholder="e.g. Homemade Premium">
                </div>
                <div class="form-group">
                    <label class="form-label">Text Color</label>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <input type="color" id="set-hero-color" class="form-input" style="width:50px;" title="Choose Text Color">
                        <span style="font-size:12px; color:#666;">Click box to pick</span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Hero Subtitle</label>
                <input type="text" id="set-hero-subtitle" class="form-input" placeholder="e.g. Happiness in every bite">
            </div>

            <div class="form-section-title">Slider Images (1-5)</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
                <div class="form-group">
                    <label class="form-label">Slide 1</label>
                    <div class="file-upload-wrapper" style="padding:10px;">
                        <span style="font-size:10px;">Upload</span>
                        <input type="file" id="hero-file-1" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-hero-1')">
                    </div>
                    <input type="hidden" id="exist-hero-1">
                    <div id="prev-hero-1" class="upload-preview-area" style="height:60px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Slide 2</label>
                    <div class="file-upload-wrapper" style="padding:10px;">
                        <span style="font-size:10px;">Upload</span>
                        <input type="file" id="hero-file-2" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-hero-2')">
                    </div>
                    <input type="hidden" id="exist-hero-2">
                    <div id="prev-hero-2" class="upload-preview-area" style="height:60px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Slide 3</label>
                    <div class="file-upload-wrapper" style="padding:10px;">
                        <span style="font-size:10px;">Upload</span>
                        <input type="file" id="hero-file-3" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-hero-3')">
                    </div>
                    <input type="hidden" id="exist-hero-3">
                    <div id="prev-hero-3" class="upload-preview-area" style="height:60px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Slide 4</label>
                    <div class="file-upload-wrapper" style="padding:10px;">
                        <span style="font-size:10px;">Upload</span>
                        <input type="file" id="hero-file-4" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-hero-4')">
                    </div>
                    <input type="hidden" id="exist-hero-4">
                    <div id="prev-hero-4" class="upload-preview-area" style="height:60px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Slide 5</label>
                    <div class="file-upload-wrapper" style="padding:10px;">
                        <span style="font-size:10px;">Upload</span>
                        <input type="file" id="hero-file-5" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-hero-5')">
                    </div>
                    <input type="hidden" id="exist-hero-5">
                    <div id="prev-hero-5" class="upload-preview-area" style="height:60px;"></div>
                </div>
            </div>
        </div>

        <div class="settings-group">
            <h3 style="margin-top:0; color:var(--primary);">üé® General Appearance</h3>
            
            <div class="form-group">
                <label class="form-label">Brand Name</label>
                <input type="text" id="set-brand-name" class="form-input" value="Pipah" oninput="updateLiveTheme()">
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="form-group">
                    <label class="form-label">Primary Color</label>
                    <input type="color" id="set-color-primary" value="#A67734" class="form-input" oninput="updateLiveTheme()">
                </div>
                <div class="form-group">
                    <label class="form-label">Background Color</label>
                    <input type="color" id="set-color-bg" value="#f4f7f6" class="form-input" oninput="updateLiveTheme()">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Announcement Banner Text</label>
                <input type="text" id="set-announcement" class="form-input" placeholder="e.g. Free Shipping above RM50!">
            </div>

            <div class="form-group">
                <label class="form-label">WhatsApp Contact</label>
                <input type="text" id="set-whatsapp" class="form-input" placeholder="601121243407">
            </div>
            
            <button class="btn btn-primary" style="width:100%; margin-top:20px;" id="btn-save-settings" onclick="saveAllSettings()">
                Save All Settings
            </button>
        </div>

      </div>
    </section>
  </main>

  <div id="productModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:200; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:25px; border-radius:15px; width:90%; max-width:500px; max-height:90vh; overflow-y:auto;">
        <h3 style="margin-top:0;">Manage Product</h3>
        <input type="hidden" id="edit-id">
        <input type="hidden" id="existing-img1">
        <input type="hidden" id="existing-img2">
        <input type="hidden" id="existing-img3">
        
        <div class="form-group">
            <label class="form-label">Product Name</label>
            <input type="text" id="edit-name" class="form-input">
        </div>
        <div class="form-group">
            <label class="form-label">Base Price (RM)</label>
            <input type="number" id="edit-price" class="form-input" step="0.01">
        </div>

        <div class="form-section-title">Tier Pricing (Bulk/Borong)</div>
        <p style="font-size:11px; color:#888; margin-top:0;">Set cheaper prices for bulk purchases.</p>
        
        <div id="tier-list-container">
            </div>
        
        <button type="button" class="btn" style="border:1px dashed #ccc; width:100%; color:var(--primary); margin-bottom:15px;" onclick="addTierRow()">
            + Add Price Tier
        </button>

        <div class="form-section-title">Product Images (Max 3)</div>
        
        <div class="form-group">
            <label class="form-label">Slot 1 (Main Cover)</label>
            <div class="file-upload-wrapper">
                <span style="color:#666; font-size:13px;"><i class="fas fa-cloud-upload-alt"></i> Upload</span>
                <input type="file" id="edit-file1" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'preview1')">
            </div>
            <div id="preview1" class="upload-preview-area"></div>
        </div>

        <div class="form-group">
            <label class="form-label">Slot 2</label>
            <div class="file-upload-wrapper">
                <span style="color:#666; font-size:13px;"><i class="fas fa-cloud-upload-alt"></i> Upload</span>
                <input type="file" id="edit-file2" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'preview2')">
            </div>
            <div id="preview2" class="upload-preview-area"></div>
        </div>

        <div class="form-group">
            <label class="form-label">Slot 3</label>
            <div class="file-upload-wrapper">
                <span style="color:#666; font-size:13px;"><i class="fas fa-cloud-upload-alt"></i> Upload</span>
                <input type="file" id="edit-file3" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'preview3')">
            </div>
            <div id="preview3" class="upload-preview-area"></div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn btn-danger" type="button" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" id="btn-save" onclick="submitProduct()">
                <span id="btn-text">Save Product</span>
                <div id="btn-spinner" class="spinner" style="display:none;"></div>
            </button>
        </div>
    </div>
  </div>

  <div id="toast" class="toast">Success!</div>

 <script>
    // *** CONFIGURATION ***
    const API_URL = "https://264d386b-ade0-4ce1-867e-b3cf83d2adbb-00-1va99hmslla0w.pike.replit.dev";
    let IS_DEMO = false;

    // --- STATE ---
    let products = [];
    let orders = [];

    window.onload = function() { loadDataFromBackend(); };

    async function loadDataFromBackend() {
        try {
            // Try connecting to the API
            const res = await fetch(`${API_URL}/api/data`);
            if(!res.ok) throw new Error("Network response was not ok");
            const data = await res.json();
            products = data.products || [];
            orders = data.orders || [];
            if(data.settings) applySettings(data.settings);
            renderOrders();
            renderProducts();
        } catch (e) {
            console.warn("Server offline or not configured. Switching to Demo Mode.");
            enableDemoMode();
        }
    }

    // --- DEMO MODE FUNCTIONS ---
    function enableDemoMode() {
        IS_DEMO = true;
        document.getElementById('demo-badge').style.display = 'block';
        showToast("Server offline. Using Demo Data.");

        // Sample Data for Testing
        products = [
            { 
                id: 'p1', name: 'Seasalt Choc Chip', price: '35.00', 
                images: ['https://placehold.co/200x200?text=Cookie+1', '', ''],
                tiers: [{minQty: 10, unitPrice: 30}, {minQty: 50, unitPrice: 28}]
            },
            { 
                id: 'p2', name: 'Red Velvet Crunchy', price: '38.00', 
                images: ['https://placehold.co/200x200?text=Cookie+2'],
                tiers: []
            }
        ];
        
        orders = [
            { id: '101', name: 'Ali Bin Abu', total: '70.00', summary: 'Seasalt Choc Chip x2', address: '123 Jalan Ampang', date: '2025-10-24' },
            { id: '102', name: 'Siti Sarah', total: '38.00', summary: 'Red Velvet x1', address: 'Kampung Baru', date: '2025-10-23' }
        ];

        renderOrders();
        renderProducts();
    }

    function applySettings(s) {
        // Branding
        if(s.primary) document.getElementById('set-color-primary').value = s.primary;
        if(s.bg) document.getElementById('set-color-bg').value = s.bg;
        if(s.brand) document.getElementById('set-brand-name').value = s.brand;
        if(s.announcement) document.getElementById('set-announcement').value = s.announcement;
        if(s.whatsapp) document.getElementById('set-whatsapp').value = s.whatsapp;

        // Hero
        if(s.heroTitle) document.getElementById('set-hero-title').value = s.heroTitle;
        if(s.heroSubtitle) document.getElementById('set-hero-subtitle').value = s.heroSubtitle;
        if(s.heroColor) document.getElementById('set-hero-color').value = s.heroColor;
        
        // Populate Hero Images
        if(s.heroImages && Array.isArray(s.heroImages)) {
            s.heroImages.forEach((img, idx) => {
                const i = idx + 1;
                if(img && document.getElementById(`prev-hero-${i}`)) {
                    document.getElementById(`exist-hero-${i}`).value = img;
                    const box = document.getElementById(`prev-hero-${i}`);
                    box.classList.add('has-file');
                    box.innerHTML = `<img src="${img}">`;
                }
            });
        }
        
        // Populate Feedback / Testimonials
        if(s.testimonialQuote) document.getElementById('set-tst-quote').value = s.testimonialQuote;
        if(s.testimonialImages && Array.isArray(s.testimonialImages)) {
            s.testimonialImages.forEach((img, idx) => {
                 const i = idx + 1;
                 if(img && document.getElementById(`prev-tst-${i}`)) {
                    document.getElementById(`exist-tst-${i}`).value = img;
                    const box = document.getElementById(`prev-tst-${i}`);
                    box.classList.add('has-file');
                    box.innerHTML = `<img src="${img}">`;
                 }
            });
        }
        
        updateLiveTheme();
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

    function switchTab(tabId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const titles = { 'orders': 'Orders Management', 'products': 'Products Inventory', 'feedback': 'Customer Feedback', 'settings': 'Store Settings' };
        document.getElementById('page-title').innerText = titles[tabId];
    }

    // --- THEME & SETTINGS ---
    function updateLiveTheme() {
        const primary = document.getElementById('set-color-primary').value;
        const bg = document.getElementById('set-color-bg').value;
        const brandName = document.getElementById('set-brand-name').value;
        
        document.documentElement.style.setProperty('--primary', primary);
        document.documentElement.style.setProperty('--primary-dark', primary); 
        document.documentElement.style.setProperty('--bg-color', bg);
        document.getElementById('sidebar-brand').innerHTML = `üç™ ${brandName}<span>Admin</span>`;
    }

    // --- TIER PRICING LOGIC ---
    function addTierRow(minQty = '', unitPrice = '') {
        const container = document.getElementById('tier-list-container');
        const rowId = 'tier-' + Date.now();
        const html = `
            <div class="tier-row" id="${rowId}">
                <input type="number" placeholder="Min Qty" class="form-input" style="flex:1" value="${minQty}">
                <input type="number" placeholder="Price (RM)" class="form-input" style="flex:1" value="${unitPrice}" step="0.01">
                <button type="button" class="remove-tier" onclick="document.getElementById('${rowId}').remove()">√ó</button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    // --- SAVE SETTINGS (Including Hero & Feedback) ---
    async function saveAllSettings() {
        // Find buttons to show loading state (could be in different tabs)
        const btnSetting = document.getElementById('btn-save-settings');
        const btnFeedback = document.getElementById('btn-save-feedback');
        
        if(btnSetting) { btnSetting.innerText = "Saving..."; btnSetting.disabled = true; }
        if(btnFeedback) { btnFeedback.innerText = "Saving..."; btnFeedback.disabled = true; }

        // Gather Hero Images
        let heroImages = [];
        for(let i=1; i<=5; i++) {
            const fileInput = document.getElementById(`hero-file-${i}`);
            const existing = document.getElementById(`exist-hero-${i}`).value;
            
            if(fileInput.files.length > 0) {
                try {
                    const b64 = await toBase64(fileInput.files[0]);
                    heroImages.push(b64);
                } catch(e) { console.log(e); heroImages.push(existing || ""); }
            } else {
                heroImages.push(existing || "");
            }
        }
        
        // Gather Testimonial Images (NOW 5)
        let tstImages = [];
        for(let i=1; i<=5; i++) {
            const fileInput = document.getElementById(`tst-file-${i}`);
            const existing = document.getElementById(`exist-tst-${i}`).value;
             if(fileInput.files.length > 0) {
                try {
                    const b64 = await toBase64(fileInput.files[0]);
                    tstImages.push(b64);
                } catch(e) { console.log(e); tstImages.push(existing || ""); }
            } else {
                tstImages.push(existing || "");
            }
        }

        const payload = {
            primary: document.getElementById('set-color-primary').value,
            bg: document.getElementById('set-color-bg').value,
            brand: document.getElementById('set-brand-name').value,
            announcement: document.getElementById('set-announcement').value,
            whatsapp: document.getElementById('set-whatsapp').value,
            // Hero Data
            heroTitle: document.getElementById('set-hero-title').value,
            heroSubtitle: document.getElementById('set-hero-subtitle').value,
            heroColor: document.getElementById('set-hero-color').value,
            heroImages: heroImages,
            // Feedback Data
            testimonialQuote: document.getElementById('set-tst-quote').value,
            testimonialImages: tstImages
        };

        if (IS_DEMO) {
            // Mock Save
            setTimeout(() => {
                showToast("Settings Saved! (Demo Mode)");
                if(btnSetting) { btnSetting.innerText = "Save All Settings"; btnSetting.disabled = false; }
                if(btnFeedback) { btnFeedback.innerText = "Save Feedback Settings"; btnFeedback.disabled = false; }
                applySettings(payload); // Apply changes visually
            }, 1000);
            return;
        }

        try {
            await fetch(`${API_URL}/api/settings`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            showToast("Settings Saved!");
        } catch(e) { showToast("Error Saving Settings"); }

        if(btnSetting) { btnSetting.innerText = "Save All Settings"; btnSetting.disabled = false; }
        if(btnFeedback) { btnFeedback.innerText = "Save Feedback Settings"; btnFeedback.disabled = false; }
    }

    // --- PRODUCTS ---
    function renderProducts() {
        const list = document.getElementById('product-list');
        list.innerHTML = '';
        products.forEach(p => {
            const img = p.images && p.images[0] ? p.images[0] : '';
            const mediaHTML = img ? `<img src="${img}" style="width:100%; height:120px; object-fit:cover; border-radius:8px;">` : `<div style="height:120px; background:#eee;"></div>`;

            list.innerHTML += `
                <div class="card">
                    ${mediaHTML}
                    <h4 style="margin:10px 0 5px;">${p.name}</h4>
                    <span class="status-badge">RM ${p.price}</span>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn" style="background:#f0f0f0; flex:1;" onclick="editProduct('${p.id}')">Edit</button>
                        <button class="btn btn-danger" style="flex:1;" onclick="deleteProduct('${p.id}')">Delete</button>
                    </div>
                </div>
            `;
        });
    }

    function editProduct(id) {
        const p = products.find(x => x.id === id);
        if(!p) return;
        document.getElementById('edit-id').value = p.id;
        document.getElementById('edit-name').value = p.name;
        document.getElementById('edit-price').value = p.price;
        
        // Populate Images (1-3)
        for(let i=1; i<=3; i++) {
            const img = (p.images && p.images[i-1]) ? p.images[i-1] : '';
            document.getElementById(`existing-img${i}`).value = img;
            const previewBox = document.getElementById(`preview${i}`);
            
            if(img) {
                previewBox.classList.add('has-file');
                previewBox.innerHTML = `<img src="${img}">`;
            } else {
                previewBox.classList.remove('has-file');
                previewBox.innerHTML = '';
            }
        }
        
        // Populate Tiers
        const tierContainer = document.getElementById('tier-list-container');
        tierContainer.innerHTML = ''; // Clear old
        if(p.tiers && Array.isArray(p.tiers)) {
            p.tiers.forEach(t => addTierRow(t.minQty, t.unitPrice));
        }

        document.getElementById('productModal').style.display = 'flex';
    }

    function openProductModal() {
        document.getElementById('edit-id').value = ''; 
        document.getElementById('edit-name').value = ''; 
        document.getElementById('edit-price').value = ''; 
        document.getElementById('tier-list-container').innerHTML = ''; // Clear tiers
        
        // Clear Images
        for(let i=1; i<=3; i++) {
            document.getElementById(`existing-img${i}`).value = '';
            document.getElementById(`edit-file${i}`).value = '';
            const box = document.getElementById(`preview${i}`);
            box.classList.remove('has-file');
            box.innerHTML = '';
        }
        
        document.getElementById('productModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('productModal').style.display = 'none'; }
    
    // --- DELETE PRODUCT ---
    async function deleteProduct(id) {
        if(!confirm("Are you sure you want to delete this product?")) return;
        
        if(IS_DEMO) {
            products = products.filter(p => p.id !== id);
            renderProducts();
            showToast("Product Removed! (Demo Mode)");
            return;
        }

        try {
            const res = await fetch(`${API_URL}/api/products/${id}`, { method: 'DELETE' });
            if(res.ok) {
                 loadDataFromBackend();
                 showToast("Product Deleted!");
            } else {
                 showToast("Error Deleting Product");
            }
        } catch(e) {
            showToast("Connection Error");
        }
    }

    async function submitProduct() {
        const btn = document.getElementById('btn-save');
        const btnText = document.getElementById('btn-text');
        btn.disabled = true; btnText.innerText = "Saving...";

        const id = document.getElementById('edit-id').value || 'p' + Date.now();
        const name = document.getElementById('edit-name').value;
        const price = document.getElementById('edit-price').value;

        // Collect Tiers
        let tiers = [];
        document.querySelectorAll('#tier-list-container .tier-row').forEach(row => {
            const inputs = row.querySelectorAll('input');
            const qty = parseInt(inputs[0].value);
            const cost = parseFloat(inputs[1].value);
            if(qty && cost) tiers.push({ minQty: qty, unitPrice: cost });
        });

        // Collect Images (3 Slots)
        let imageUrls = [];
        for(let i=1; i<=3; i++) {
            const fileInput = document.getElementById(`edit-file${i}`);
            const existing = document.getElementById(`existing-img${i}`).value;
            
            if(fileInput.files.length > 0) {
                try {
                    const b64 = await toBase64(fileInput.files[0]);
                    imageUrls.push(b64);
                } catch(e) { imageUrls.push(existing || ""); }
            } else {
                imageUrls.push(existing || "");
            }
        }

        const productData = { id, name, price, images: imageUrls, tiers: tiers };

        if(IS_DEMO) {
            // Mock Save
            setTimeout(() => {
                const existingIdx = products.findIndex(p => p.id === id);
                if(existingIdx >= 0) products[existingIdx] = productData;
                else products.push(productData);
                
                closeModal();
                renderProducts();
                showToast("Product Saved! (Demo Mode)");
                btn.disabled = false; btnText.innerText = "Save Product";
            }, 1000);
            return;
        }

        try {
            await fetch(`${API_URL}/api/products`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(productData)
            });
            closeModal();
            loadDataFromBackend();
            showToast("Product Saved!");
        } catch (e) {
            showToast("Error saving product");
        }
        btn.disabled = false; btnText.innerText = "Save Product";
    }

    // --- ORDERS & UTILS ---
    function renderOrders() {
        const list = document.getElementById('order-list');
        document.getElementById('order-badge').innerText = orders.length;
        list.innerHTML = '';
        if(orders.length===0) list.innerHTML = '<div style="color:#999; text-align:center; padding:20px;">No active orders</div>';
        
        orders.forEach(o => {
            list.innerHTML += `
                <div class="order-card">
                    <div class="order-header">
                        <span>${o.name}</span>
                        <span style="color:var(--primary)">RM${o.total}</span>
                    </div>
                    <div class="order-items">${o.summary}</div>
                    <div style="margin-top:5px; font-size:12px; color:#555;">${o.address}</div>
                    <div style="text-align:right; margin-top:10px;">
                         <button class="btn btn-success" onclick="markDone('${o.id}')">Complete</button>
                    </div>
                </div>`;
        });
    }

    async function markDone(id) {
        if(!confirm("Order completed?")) return;
        
        if(IS_DEMO) {
            orders = orders.filter(o => o.id !== id);
            renderOrders();
            showToast("Order Completed! (Demo Mode)");
            return;
        }

        await fetch(`${API_URL}/api/orders/status`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, status: 'completed' })
        });
        loadDataFromBackend(); showToast("Order Completed!");
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'), 3000);
    }
    
    function previewFile(input, previewId) {
        const box = document.getElementById(previewId);
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            box.classList.add('has-file');
            reader.onload = function(e) { box.innerHTML = `<img src="${e.target.result}">`; }
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>

</body>
</html>
