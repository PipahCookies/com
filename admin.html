<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#A67734">
  <title>Admin Panel ‚Äî PipahCookies</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- CSS STYLES --- */
    :root {
      --primary: #A67734;       
      --primary-dark: #8b5e2b;  
      --bg-color: #f4f7f6;      
      --sidebar-bg: #ffffff;
      --text-main: #333;
      --text-muted: #888;
      --success: #2ecc71;
      --danger: #e74c3c;
      --radius: 12px;
      --shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

    body {
      margin: 0; font-family: 'Poppins', sans-serif;
      background: var(--bg-color); color: var(--text-main);
      display: flex; min-height: 100vh;
      transition: background 0.3s;
    }

    /* --- Sidebar --- */
    .sidebar {
      width: 250px; background: var(--sidebar-bg);
      padding: 20px; display: flex; flex-direction: column;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      position: fixed; top: 0; bottom: 0; left: 0; z-index: 100;
      transition: transform 0.3s;
    }
    .brand {
      font-size: 20px; font-weight: 700; color: var(--primary);
      margin-bottom: 40px; display: flex; align-items: center; gap: 10px;
      transition: color 0.3s;
    }
    .nav-link {
      padding: 12px 15px; margin-bottom: 8px;
      border-radius: var(--radius); cursor: pointer;
      color: var(--text-muted); font-weight: 500;
      transition: 0.2s; display: flex; align-items: center; gap: 10px;
    }
    .nav-link:hover, .nav-link.active { background: var(--primary); color: #fff; }

    /* --- Main Content --- */
    .main-content { flex: 1; margin-left: 250px; padding: 30px; width: 100%; }

    .page-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
    }
    .page-title { font-size: 24px; font-weight: 600; }
    .menu-toggle { display: none; font-size: 24px; background: none; border: none; cursor: pointer; }

    .view-section { display: none; animation: fadeIn 0.3s; }
    .view-section.active { display: block; }

    /* --- Grid & Cards --- */
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .card {
      background: #fff; border-radius: var(--radius); padding: 20px;
      box-shadow: var(--shadow); position: relative; display: flex; flex-direction: column;
    }
    .status-badge { background: #e0f2f1; color: #009688; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }

    /* --- Forms & Uploads --- */
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; }
    .form-input {
      width: 100%; padding: 10px; border: 1px solid #eee;
      border-radius: 8px; font-family: inherit; font-size: 14px;
    }
    textarea.form-input { resize: vertical; }
    .form-input[type="color"] { padding: 0; border: none; height: 40px; width: 100%; cursor: pointer; }

    .file-upload-wrapper {
        border: 2px dashed #ddd; border-radius: 8px; padding: 15px;
        text-align: center; cursor: pointer; transition: 0.2s; position: relative;
        background: #fafafa;
    }
    .file-upload-wrapper:hover { border-color: var(--primary); background: #fffcf8; }
    .file-input-hidden { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    .upload-preview-area {
        margin-top: 10px; height: 100px; background: #eee; border-radius: 6px;
        display: none; align-items: center; justify-content: center; overflow: hidden;
    }
    .upload-preview-area.has-file { display: flex; }
    .upload-preview-area img { max-width: 100%; max-height: 100%; object-fit: contain; }

    .form-section-title {
        font-size: 14px; font-weight: 700; color: var(--primary); 
        margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;
    }

    .btn {
      padding: 10px 20px; border-radius: 8px; border: none;
      cursor: pointer; font-weight: 500; font-size: 14px; transition: 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-danger { background: #ffebee; color: var(--danger); }
    .btn-success { background: var(--success); color: white; }

    /* --- Orders List Styles --- */
    .order-card {
      background: #fff; margin-bottom: 15px; padding: 20px;
      border-radius: var(--radius); box-shadow: var(--shadow);
      display: flex; flex-direction: column; gap: 10px;
      border-left: 4px solid var(--primary);
    }
    .order-header {
        display: flex; justify-content: space-between; align-items: center;
        padding-bottom: 10px; border-bottom: 1px dashed #eee;
    }
    .order-header strong { font-size: 16px; color: var(--primary-dark); }
    .order-details ul { list-style: none; padding-left: 0; margin: 5px 0 0; font-size: 13px; }
    .order-details li { margin-bottom: 3px; color: var(--text-muted); }
    .order-total {
        font-size: 16px; font-weight: 700; color: var(--danger);
        padding-top: 10px; border-top: 1px dashed #eee;
    }
    .order-actions { margin-top: 10px; }

    /* --- Settings & Tier Styling --- */
    .settings-container { display: flex; flex-direction: column; gap: 20px; max-width: 700px; }
    .settings-group {
      background: #fff; padding: 25px; border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .testimonial-block {
        border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fdfdfd;
    }

    /* --- Toast & Responsive --- */
    .toast {
      position: fixed; bottom: 20px; right: 20px;
      background: #333; color: #fff; padding: 12px 24px;
      border-radius: 8px; opacity: 0; pointer-events: none;
      transform: translateY(10px); transition: 0.3s; z-index: 1000;
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    .demo-badge {
        position: fixed; top: 10px; right: 10px; background: orange; color: black;
        padding: 5px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; z-index: 200;
        /* display: none; */ /* Initially hidden, JS controls visibility */
    }

    .server-config {
        margin-top: auto; padding-top: 15px; border-top: 1px solid #eee;
        display: flex; flex-direction: column; gap: 5px;
    }
    .server-config input { font-size: 10px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
    .server-config button { font-size: 10px; padding: 4px; background: #333; color: #fff; border:none; border-radius:4px; cursor:pointer;}

    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); width: 80%; }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0; padding: 20px; }
      .menu-toggle { display: block; color: var(--primary); }
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div id="demo-badge" class="demo-badge" style="display:none;">DEMO MODE (Server Disconnected)</div>

  <aside class="sidebar" id="sidebar">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div class="brand" id="sidebar-brand" style="margin-bottom: 0;">üç™ Pipah<span>Admin</span></div>
        <button onclick="toggleSidebar()" style="background:none; border:none; font-size:24px; color:#999; display: block; padding: 0;">‚úï</button>
    </div>
    <nav>
      <div class="nav-link active" onclick="switchTab('orders'); toggleSidebar();">üì¶ Orders</div>
      <div class="nav-link" onclick="switchTab('products'); toggleSidebar();">üç™ Products</div>
      <div class="nav-link" onclick="switchTab('gallery'); toggleSidebar();">üíé 3D Gallery</div>
      <div class="nav-link" onclick="switchTab('settings'); toggleSidebar();">‚öôÔ∏è Settings</div>
    </nav>

    <div class="server-config">
        <label style="font-size:10px; color:#999;">Server Connection:</label>
        <input type="text" id="api-url-input" placeholder="Enter API URL here">
        <button onclick="updateApiUrl()">Reconnect</button>
    </div>
  </aside>

  <main class="main-content">
    <header class="page-header">
      <div style="display:flex; align-items:center; gap:15px;">
        <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
        <h1 class="page-title" id="page-title">Orders Management</h1>
      </div>
      <div id="loader" style="font-size:14px; color:#888; display:none;">Loading...</div>
    </header>

    <section id="orders" class="view-section active">
      <div id="order-list">Loading orders...</div>
    </section>

    <section id="gallery" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <p style="color:#666; font-size:13px;">Items for the 3D Rotating Gallery</p>
            <button class="btn btn-primary" onclick="openAddGalleryModal()">
                <i class="fas fa-plus"></i> Add Gallery Item
            </button>
        </div>
        <div class="grid-container" id="gallery-list"></div>
    </section>

    <section id="products" class="view-section">
      <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
        <button class="btn btn-primary" onclick="openAddProductModal()">
            <i class="fas fa-plus"></i> Add New Product
        </button>
      </div>
      <div class="grid-container" id="product-list"></div>
    </section>

    <section id="settings" class="view-section">
      <div class="settings-container">

        <div class="settings-group">
            <h3 style="margin-top:0; color:var(--primary);">üé® Branding & Colors</h3>
            <div class="form-group"><label class="form-label">Brand Name</label><input type="text" id="set-brand-name" class="form-input" oninput="updateLiveTheme()"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="form-group"><label class="form-label">Primary Color</label><input type="color" id="set-color-primary" class="form-input" oninput="updateLiveTheme()"></div>
                <div class="form-group"><label class="form-label">Background Color</label><input type="color" id="set-color-bg" class="form-input" oninput="updateLiveTheme()"></div>
            </div>
        </div>

        <div class="settings-group">
            <h3 style="margin-top:0; color:var(--primary);">üñºÔ∏è Homepage Hero Slider</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="form-group"><label class="form-label">Hero Title</label><input type="text" id="set-hero-title" class="form-input"></div>
                <div class="form-group"><label class="form-label">Text Color</label><input type="color" id="set-hero-color" class="form-input" style="width:50px;"></div>
            </div>
            <div class="form-group"><label class="form-label">Hero Subtitle</label><input type="text" id="set-hero-subtitle" class="form-input"></div>

            <div class="form-section-title">Slider Images (Max 3)</div>
            <div class="form-group">
                <label class="form-label">Slide 1</label>
                <div class="file-upload-wrapper">
                    <input type="file" id="hero-file-1" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-hero-1')">
                    <span style="font-size:10px;">Upload</span>
                </div>
                <input type="hidden" id="exist-hero-1">
                <div id="prev-hero-1" class="upload-preview-area" style="height:60px;"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Slide 2</label>
                <div class="file-upload-wrapper">
                    <input type="file" id="hero-file-2" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-hero-2')">
                    <span style="font-size:10px;">Upload</span>
                </div>
                <input type="hidden" id="exist-hero-2">
                <div id="prev-hero-2" class="upload-preview-area" style="height:60px;"></div>
            </div>
             <div class="form-group">
                <label class="form-label">Slide 3</label>
                <div class="file-upload-wrapper">
                    <input type="file" id="hero-file-3" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-hero-3')">
                    <span style="font-size:10px;">Upload</span>
                </div>
                <input type="hidden" id="exist-hero-3">
                <div id="prev-hero-3" class="upload-preview-area" style="height:60px;"></div>
            </div>
        </div>

        <div class="settings-group">
            <h3 style="margin-top:0; color:var(--primary);">üí¨ Testimonials</h3>
            <div class="testimonial-block">
                <div class="form-label">Testimonial #1</div>
                <div style="display:flex; gap:15px; align-items:flex-start;">
                    <div style="width:80px;">
                        <div class="file-upload-wrapper" style="padding:10px;">
                            <input type="file" id="tst-file-1" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-tst-1')">
                            <span style="font-size:9px;">Img</span>
                        </div>
                        <input type="hidden" id="exist-tst-1">
                        <div id="prev-tst-1" class="upload-preview-area" style="height:60px; margin-top:5px;"></div>
                    </div>
                    <textarea id="tst-quote-1" class="form-input" rows="3" placeholder="Quote..."></textarea>
                </div>
            </div>
            <div class="testimonial-block">
                <div class="form-label">Testimonial #2</div>
                <div style="display:flex; gap:15px; align-items:flex-start;">
                    <div style="width:80px;">
                        <div class="file-upload-wrapper" style="padding:10px;">
                            <input type="file" id="tst-file-2" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-tst-2')">
                            <span style="font-size:9px;">Img</span>
                        </div>
                        <input type="hidden" id="exist-tst-2">
                        <div id="prev-tst-2" class="upload-preview-area" style="height:60px; margin-top:5px;"></div>
                    </div>
                    <textarea id="tst-quote-2" class="form-input" rows="3" placeholder="Quote..."></textarea>
                </div>
            </div>
             <div class="testimonial-block">
                <div class="form-label">Testimonial #3</div>
                <div style="display:flex; gap:15px; align-items:flex-start;">
                    <div style="width:80px;">
                        <div class="file-upload-wrapper" style="padding:10px;">
                            <input type="file" id="tst-file-3" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'prev-tst-3')">
                            <span style="font-size:9px;">Img</span>
                        </div>
                        <input type="hidden" id="exist-tst-3">
                        <div id="prev-tst-3" class="upload-preview-area" style="height:60px; margin-top:5px;"></div>
                    </div>
                    <textarea id="tst-quote-3" class="form-input" rows="3" placeholder="Quote..."></textarea>
                </div>
            </div>
        </div>

        <button class="btn btn-primary" style="width:100%; height:50px; font-size:16px;" onclick="saveAllSettings()">
            <i class="fas fa-save"></i> Save All Settings
        </button>

      </div>
    </section>
  </main>

  <div id="productModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:200; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:25px; border-radius:15px; width:90%; max-width:500px; max-height:90vh; overflow-y:auto;">
        <h3 id="modal-product-title" style="margin-top:0;">Manage Product</h3>
        <input type="hidden" id="edit-id">
        <input type="hidden" id="existing-img1"><input type="hidden" id="existing-img2"><input type="hidden" id="existing-img3">

        <div class="form-group"><label class="form-label">Product Name</label><input type="text" id="edit-name" class="form-input"></div>
        <div class="form-group"><label class="form-label">Base Price (RM)</label><input type="number" id="edit-price" class="form-input" step="0.01"></div>

        <div class="form-section-title">Product Images (Max 3)</div>
        <div class="form-group"><div class="file-upload-wrapper"><input type="file" id="edit-file1" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'preview1')"><span>Slot 1</span></div><div id="preview1" class="upload-preview-area"></div></div>
        <div class="form-group"><div class="file-upload-wrapper"><input type="file" id="edit-file2" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'preview2')"><span>Slot 2</span></div><div id="preview2" class="upload-preview-area"></div></div>
        <div class="form-group"><div class="file-upload-wrapper"><input type="file" id="edit-file3" class="file-input-hidden" accept="image/*" onchange="previewFile(this, 'preview3')"><span>Slot 3</span></div><div id="preview3" class="upload-preview-area"></div></div>

        <div style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn btn-danger" type="button" onclick="closeModal('productModal')">Cancel</button>
            <button class="btn btn-primary" id="btn-save" onclick="submitProduct()">Save Product</button>
        </div>
    </div>
  </div>

  <div id="galleryModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:201; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:25px; border-radius:15px; width:90%; max-width:500px; max-height:90vh; overflow-y:auto;">
        <h3 style="margin-top:0;">Gallery Item</h3>
        <input type="hidden" id="gal-id">
        <input type="hidden" id="gal-existing-media">

        <div class="form-group"><label class="form-label">Product Name</label><input type="text" id="gal-name" class="form-input"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div class="form-group"><label class="form-label">Price (RM)</label><input type="number" id="gal-price" class="form-input" step="0.01"></div>
            <div class="form-group"><label class="form-label">Stock Qty</label><input type="number" id="gal-stock" class="form-input"></div>
        </div>
        <div class="form-group">
             <label style="display:flex; align-items:center; gap:8px; font-size:12px; margin-bottom:5px;">
                <input type="checkbox" id="gal-is-video"> Is this a Video file?
             </label>
            <div class="file-upload-wrapper">
                <span style="color:#666; font-size:13px;"><i class="fas fa-cloud-upload-alt"></i> Upload Media</span>
                <input type="file" id="gal-file" class="file-input-hidden" accept="image/*,video/*" onchange="previewFile(this, 'gal-preview')">
            </div>
            <div id="gal-preview" class="upload-preview-area" style="height:150px;"></div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn btn-danger" type="button" onclick="closeModal('galleryModal')">Cancel</button>
            <button class="btn btn-primary" id="btn-save-gal" onclick="submitGalleryItem()">Save Item</button>
        </div>
    </div>
  </div>

  <div id="toast" class="toast">Success!</div>

<script>
    // --- API CONFIGURATION ---
    let API_URL = ""; 

    let IS_DEMO = false;
    let products = [];
    let galleryItems = [];
    let orders = [];

    // --- INITIALIZATION ---
    window.onload = function() {
        // 1. Ambil URL tersimpan atau gunakan domain saat ini (window.location.origin)
        const savedUrl = localStorage.getItem('pipah_api_url');
        if(savedUrl) {
            API_URL = savedUrl;
        } else {
            // Ini yang penting: menggunakan origin agar otomatis mengarah ke server Replit
            API_URL = window.location.origin; 
        }

        document.getElementById('api-url-input').value = API_URL;
        loadDataFromBackend();

        // Setup listeners
        document.getElementById('save-settings').addEventListener('click', saveAllSettings);
    };

    function updateApiUrl() {
        const val = document.getElementById('api-url-input').value.trim();
        const cleanVal = val.replace(/\/$/, "");
        API_URL = cleanVal;

        if(API_URL) localStorage.setItem('pipah_api_url', API_URL);
        else localStorage.removeItem('pipah_api_url');

        loadDataFromBackend();
    }

    // --- HELPER FUNCTIONS ---
    function escapeHtml(text) {
        if (typeof text !== 'string') return text;
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    // Fungsi utilitas untuk mendapatkan file base64 atau URL yang sudah ada
    async function getFileOrExisting(fileId, hiddenId) {
        const fileInput = document.getElementById(fileId);
        const existing = document.getElementById(hiddenId).value;
        if (fileInput.files && fileInput.files[0]) {
            return await toBase64(fileInput.files[0]);
        }
        return existing;
    }


    // --- FETCH DATA ---
    async function loadDataFromBackend() {
        const loader = document.getElementById('loader');
        if(loader) loader.style.display = 'block';

        // Tampilkan pesan loading di tab orders dan products
        document.getElementById('order-list').innerHTML = '<p class="text-muted" style="text-align:center;">Loading orders...</p>';
        document.getElementById('product-list').innerHTML = '<p class="text-muted" style="text-align:center;">Loading products...</p>';

        try {
            // Menggunakan endpoint /api/data untuk mendapatkan semua data sekaligus
            const res = await fetch(`${API_URL}/api/data`);
            if(!res.ok) throw new Error(`Connection failed with status: ${res.status}`);

            const data = await res.json();

            products = data.products || [];
            galleryItems = data.gallery || []; 
            orders = data.orders || [];

            if(data.settings) applySettingsToForm(data.settings);

            // Successfully connected
            IS_DEMO = false;
            document.getElementById('demo-badge').style.display = 'none';

            renderOrders(); 
            renderProducts(); 
            renderGallery(); 
            showToast("Data berhasil dimuat!");

        } catch (e) {
            console.warn("Backend error, switching to Demo:", e);
            enableDemoMode();
        } finally {
            if(loader) loader.style.display = 'none';
        }
    }

    function enableDemoMode() {
        IS_DEMO = true;
        document.getElementById('demo-badge').style.display = 'block';
        showToast("Server Offline - Demo Mode");
        // Jika demo mode, tampilkan pesan error yang lebih jelas
        document.getElementById('order-list').innerHTML = '<p class="text-danger" style="text-align:center;">‚ùå Server tidak dapat dihubungi. Menampilkan data demo.</p>';
        document.getElementById('product-list').innerHTML = '<p class="text-danger" style="text-align:center;">‚ùå Server tidak dapat dihubungi. Menampilkan data demo.</p>';
    }

    // --- RENDER FUNCTIONS (FIXED) ---

    function renderOrders() {
        const list = document.getElementById('order-list'); 
        list.innerHTML = '';
        if(orders.length === 0) {
             list.innerHTML = '<div style="color:#999; text-align:center; padding: 50px;">Belum ada pesanan masuk.</div>';
             return;
        }

        orders.forEach((o, index) => {
            // Hitung total harga
            const total = o.cart ? o.cart.reduce((sum, item) => sum + (parseFloat(item.price) * parseInt(item.quantity)), 0) : 0;
            // Format tanggal
            const date = new Date(o.date || Date.now());
            const formattedDate = date.toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric' });
            const formattedTime = date.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });

            // Status: 0=New, 1=Complete (Asumsi)
            const statusText = o.status === 1 ? 'Complete' : 'New Order';
            const statusClass = o.status === 1 ? 'btn-success' : 'btn-primary';

            // Generate list items for cart
            const cartItemsHtml = o.cart ? o.cart.map(item => `
                <li>${escapeHtml(item.name)} x ${item.quantity} (RM ${parseFloat(item.price).toFixed(2)})</li>
            `).join('') : '<li>No items in cart.</li>';

            list.innerHTML += `
                <div class="order-card">
                    <div class="order-header">
                        <strong>#${o.id || `ORDER-${index + 1}`}</strong>
                        <span class="status-badge" style="background:${o.status === 1 ? '#e0f2f1' : '#fbe5e7'}; color:${o.status === 1 ? '#009688' : '#e74c3c'};">${statusText}</span>
                    </div>
                    <div class="order-body">
                        <p><strong>Nama:</strong> ${escapeHtml(o.customerName || 'N/A')}</p>
                        <p><strong>Phone:</strong> ${escapeHtml(o.customerPhone || 'N/A')}</p>
                        <p><strong>Alamat:</strong> ${escapeHtml(o.customerAddress || 'N/A')}</p>
                        <p style="font-size:12px; color:#999;">Dipesan pada: ${formattedDate}, ${formattedTime}</p>

                        <div class="order-details">
                            <h6>Items (${o.cart ? o.cart.length : 0}):</h6>
                            <ul>${cartItemsHtml}</ul>
                        </div>
                    </div>
                    <p class="order-total">Total Bayaran: RM ${total.toFixed(2)}</p>
                    <div class="order-actions">
                        <button class="btn ${statusClass} btn-sm" onclick="markOrderComplete('${o.id}')">
                            <i class="fas fa-check"></i> ${o.status === 1 ? 'Completed' : 'Mark as Complete'}
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOrder('${o.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>`;
        });
    }

    function renderProducts() {
        const list = document.getElementById('product-list'); 
        list.innerHTML = '';
        products.forEach(p => {
            const img = p.images && p.images[0] ? p.images[0] : 'https://placehold.co/400x300/f4f4f4/A67734?text=No+Image';
            list.innerHTML += `
                <div class="card">
                    <img src="${img}" onerror="this.src='https://placehold.co/400x300/f4f4f4/A67734?text=Error+Loading'" style="width:100%; height:120px; object-fit:cover; border-radius:8px; margin-bottom: 10px;">
                    <h4 style="margin:0 0 5px;">${escapeHtml(p.name)}</h4>
                    <span style="font-weight:bold; color:var(--primary)">RM ${parseFloat(p.price).toFixed(2)}</span>
                    <div style="display:flex; gap:5px; margin-top:15px;">
                        <button class="btn" style="flex:1; background:#eee;" onclick="editProduct('${p.id}')">Edit</button>
                        <button class="btn btn-danger" style="flex:1;" onclick="deleteProduct('${p.id}')">Del</button>
                    </div>
                </div>`;
        });
    }

    function renderGallery() {
        const list = document.getElementById('gallery-list'); list.innerHTML = '';
        galleryItems.forEach(g => {
            list.innerHTML += `
            <div class="card">
                ${g.isVideo 
                    ? `<div style="height:100px; background:#000; color:#fff; display:flex; align-items:center; justify-content:center; border-radius:8px;"><i class="fas fa-video"></i> Video Item</div>` 
                    : `<img src="${g.mediaUrl}" style="height:100px; object-fit:cover; border-radius:8px;">`
                }
                <h4 style="margin:10px 0;">${escapeHtml(g.name)}</h4>
                <div style="font-size:12px; color:#666;">RM ${parseFloat(g.price).toFixed(2)} | Stock: ${g.stock}</div>
                <div style="display:flex; gap:5px; margin-top:15px;">
                    <button class="btn" style="flex:1; background:#eee;" onclick="editGalleryItem('${g.id}')">Edit</button>
                    <button class="btn btn-danger" style="flex:1;" onclick="deleteGallery('${g.id}')">Delete</button>
                </div>
            </div>`;
        });
    }

    // --- ORDER ACTIONS ---
    async function markOrderComplete(id) {
        if(IS_DEMO) { showToast("Cannot mark complete in Demo Mode."); return; }

        try {
            await fetch(`${API_URL}/api/orders/complete/${id}`, { method: 'POST' });
            loadDataFromBackend();
            showToast("Order Marked Complete!");
        } catch (e) {
            console.error(e);
            showToast("Error updating order status.");
        }
    }

    async function deleteOrder(id) {
        if(IS_DEMO) { showToast("Cannot delete in Demo Mode."); return; }
        if(!confirm('Are you sure you want to delete this order?')) return;

        try {
            await fetch(`${API_URL}/api/orders/${id}`, { method: 'DELETE' });
            loadDataFromBackend();
            showToast("Order Deleted!");
        } catch (e) {
            console.error(e);
            showToast("Error deleting order.");
        }
    }


    // --- PRODUCT MANAGEMENT ---

    // 1. Open Modal for NEW Product
    function openAddProductModal() {
        document.getElementById('edit-id').value = "";
        document.getElementById('edit-name').value = "";
        document.getElementById('edit-price').value = "";
        document.getElementById('modal-product-title').innerText = "Add New Product";

        ['1','2','3'].forEach(i => {
            document.getElementById(`edit-file${i}`).value = "";
            document.getElementById(`existing-img${i}`).value = "";
            const prev = document.getElementById(`preview${i}`);
            prev.innerHTML = "";
            prev.classList.remove('has-file');
        });

        document.getElementById('productModal').style.display = 'flex';
    }

    // 2. Open Modal for EDIT Product
    function editProduct(id) {
        const p = products.find(x => x.id === id);
        if(!p) return;

        document.getElementById('edit-id').value = p.id;
        document.getElementById('edit-name').value = p.name;
        document.getElementById('edit-price').value = p.price;
        document.getElementById('modal-product-title').innerText = "Edit Product";

        ['1','2','3'].forEach((num, idx) => {
            const imgData = p.images && p.images[idx] ? p.images[idx] : "";
            document.getElementById(`existing-img${num}`).value = imgData;
            document.getElementById(`edit-file${num}`).value = ""; 
            const prev = document.getElementById(`preview${num}`);
            if(imgData) {
                // Ensure placeholder fallback for base64 images that might fail to render
                prev.innerHTML = `<img src="${imgData}" onerror="this.src='https://placehold.co/400x300/f4f4f4/A67734?text=Error'" style="height:100%">`;
                prev.classList.add('has-file');
            } else {
                prev.innerHTML = "";
                prev.classList.remove('has-file');
            }
        });

        document.getElementById('productModal').style.display = 'flex';
    }

    // 3. Submit Product
    async function submitProduct() {
        const btn = document.getElementById('btn-save');
        const originalText = btn.innerText;
        btn.innerText = "Saving..."; btn.disabled = true;

        try {
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const price = document.getElementById('edit-price').value;

            const img1 = await getFileOrExisting('edit-file1', 'existing-img1');
            const img2 = await getFileOrExisting('edit-file2', 'existing-img2');
            const img3 = await getFileOrExisting('edit-file3', 'existing-img3');
            // Filter out empty strings
            const images = [img1, img2, img3].filter(i => i && i.length > 0);

            const productData = {
                id: id || Date.now().toString(),
                name, price, images
            };

            if (!IS_DEMO) {
                await fetch(`${API_URL}/api/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
            }

            closeModal('productModal');
            loadDataFromBackend();
            showToast("Product Saved!");

        } catch (error) {
            console.error(error);
            showToast("Error saving product");
        } finally {
            btn.innerText = originalText; btn.disabled = false;
        }
    }

    async function deleteProduct(id){ 
        if(IS_DEMO) { showToast("Cannot delete in Demo Mode."); return; }
        if(!confirm('Delete this product?')) return;
        try {
            await fetch(`${API_URL}/api/products/${id}`,{method:'DELETE'}); 
            loadDataFromBackend(); 
            showToast("Product Deleted!");
        } catch (e) {
            console.error(e);
            showToast("Error deleting product.");
        }
    }

    // --- GALLERY MANAGEMENT ---

    function openAddGalleryModal() {
        document.getElementById('gal-id').value = "";
        document.getElementById('gal-name').value = "";
        document.getElementById('gal-price').value = "";
        document.getElementById('gal-stock').value = "";
        document.getElementById('gal-existing-media').value = "";
        document.getElementById('gal-file').value = "";
        document.getElementById('gal-is-video').checked = false;
        document.getElementById('gal-preview').innerHTML = "";
        document.getElementById('gal-preview').classList.remove('has-file');
        document.getElementById('galleryModal').style.display='flex';
    }

    function editGalleryItem(id) {
        const g = galleryItems.find(x => x.id === id);
        if(!g) return;

        document.getElementById('gal-id').value = g.id;
        document.getElementById('gal-name').value = g.name;
        document.getElementById('gal-price').value = g.price;
        document.getElementById('gal-stock').value = g.stock;
        document.getElementById('gal-is-video').checked = g.isVideo;
        document.getElementById('gal-existing-media').value = g.mediaUrl;
        document.getElementById('gal-file').value = "";

        const prev = document.getElementById('gal-preview');
        if(g.mediaUrl) {
             if (g.isVideo) {
                 prev.innerHTML = `<div style="font-size:12px; color:#A67734;">Video URL loaded.</div>`;
             } else {
                 prev.innerHTML = `<img src="${g.mediaUrl}" style="height:100%">`;
             }
             prev.classList.add('has-file');
        } else {
            prev.innerHTML = "";
            prev.classList.remove('has-file');
        }

        document.getElementById('galleryModal').style.display='flex';
    }


    async function submitGalleryItem() {
        const btn = document.getElementById('btn-save-gal');
        const oldText = btn.innerText;
        btn.innerText = "Saving..."; btn.disabled = true;

        try {
            const id = document.getElementById('gal-id').value;
            const name = document.getElementById('gal-name').value;
            const price = parseFloat(document.getElementById('gal-price').value);
            const stock = parseInt(document.getElementById('gal-stock').value);
            const isVideo = document.getElementById('gal-is-video').checked;
            const mediaUrl = await getFileOrExisting('gal-file', 'gal-existing-media');

            const galleryData = { 
                id: id || Date.now().toString(),
                name, 
                price: isNaN(price) ? 0 : price, 
                stock: isNaN(stock) ? 0 : stock, 
                isVideo, 
                mediaUrl 
            };

            if (!IS_DEMO) {
                await fetch(`${API_URL}/api/gallery`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(galleryData)
                });
            }
            closeModal('galleryModal');
            loadDataFromBackend();
            showToast("Gallery Item Saved!");

        } catch (e) {
            console.error(e);
            showToast("Error saving gallery item");
        } finally {
            btn.innerText = oldText; btn.disabled = false;
        }
    }

    async function deleteGallery(id){ 
        if(IS_DEMO) { showToast("Cannot delete in Demo Mode."); return; }
        if(!confirm('Delete this item?')) return;
        try {
            await fetch(`${API_URL}/api/gallery/${id}`,{method:'DELETE'}); 
            loadDataFromBackend(); 
            showToast("Gallery Item Deleted!");
        } catch (e) {
            console.error(e);
            showToast("Error deleting gallery item.");
        }
    }


    // --- SETTINGS (HERO + TESTIMONIALS) ---
    function applySettingsToForm(s) {
        // Apply form values
        if(s.primary) document.getElementById('set-color-primary').value = s.primary;
        if(s.bg) document.getElementById('set-color-bg').value = s.bg;
        if(s.brand) document.getElementById('set-brand-name').value = s.brand;
        if(s.heroTitle) document.getElementById('set-hero-title').value = s.heroTitle;
        if(s.heroSubtitle) document.getElementById('set-hero-subtitle').value = s.heroSubtitle;
        if(s.heroColor) document.getElementById('set-hero-color').value = s.heroColor;

        // Apply Hero Images
        for(let i=1; i<=3; i++) {
            const img = s.heroImages && s.heroImages[i-1] ? s.heroImages[i-1] : "";
            document.getElementById(`exist-hero-${i}`).value = img;
            const prev = document.getElementById(`prev-hero-${i}`);
            prev.innerHTML = "";
            prev.classList.remove('has-file');
            if(img) {
                prev.innerHTML = `<img src="${img}" style="height:100%">`;
                prev.classList.add('has-file');
            }
        }

        // Apply Testimonials
        for(let i=1; i<=3; i++) {
            const t = s.testimonials && s.testimonials[i-1] ? s.testimonials[i-1] : {};
            document.getElementById(`tst-quote-${i}`).value = t.quote || "";
            document.getElementById(`exist-tst-${i}`).value = t.image || "";

            const prev = document.getElementById(`prev-tst-${i}`);
            prev.innerHTML = "";
            prev.classList.remove('has-file');
            if(t.image) {
                prev.innerHTML = `<img src="${t.image}" style="height:100%">`;
                prev.classList.add('has-file');
            }
        }
        updateLiveTheme();
    }

    async function saveAllSettings() {
        if(IS_DEMO) { showToast("Cannot save settings in Demo Mode."); return; }

        const btn = document.querySelector('#settings button');
        const oldText = btn.innerHTML;
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Saving..."; btn.disabled = true;

        try {
            const primary = document.getElementById('set-color-primary').value;
            const bg = document.getElementById('set-color-bg').value;
            const brand = document.getElementById('set-brand-name').value;
            const heroTitle = document.getElementById('set-hero-title').value;
            const heroSubtitle = document.getElementById('set-hero-subtitle').value;
            const heroColor = document.getElementById('set-hero-color').value;

            const heroImages = [];
            for(let i=1; i<=3; i++) {
                const img = await getFileOrExisting(`hero-file-${i}`, `exist-hero-${i}`);
                if(img) heroImages.push(img);
            }

            const testimonials = [];
            for(let i=1; i<=3; i++) {
                const img = await getFileOrExisting(`tst-file-${i}`, `exist-tst-${i}`);
                const quote = document.getElementById(`tst-quote-${i}`).value;
                if(img || quote) testimonials.push({ image: img, quote: quote });
            }

            const settingsData = {
                primary, bg, brand, heroTitle, heroSubtitle, heroColor, heroImages, testimonials
            };

            await fetch(`${API_URL}/api/settings`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settingsData)
            });

            loadDataFromBackend(); // Reload data to confirm changes
            showToast("Settings Saved!");

        } catch(e) {
            console.error(e);
            showToast("Error saving settings");
        } finally {
            btn.innerHTML = oldText; btn.disabled = false;
        }
    }

    function updateLiveTheme() {
        // Simple live preview of colors on the admin panel itself
        const p = document.getElementById('set-color-primary').value;
        const b = document.getElementById('set-brand-name').value;
        const bg = document.getElementById('set-color-bg').value;

        document.documentElement.style.setProperty('--primary', p);
        // Slightly darken primary color for better contrast in some elements
        const primaryDark = darkenColor(p, -15); 
        document.documentElement.style.setProperty('--primary-dark', primaryDark);
        document.documentElement.style.setProperty('--bg-color', bg);

        if(b) document.getElementById('sidebar-brand').innerHTML = `üç™ ${escapeHtml(b)}<span>Admin</span>`;
    }

    function darkenColor(hex, lum) {
        // Validate hex string
        hex = String(hex).replace(/[^0-9a-f]/gi, '');
        if (hex.length < 6) { hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]; }
        lum = lum || 0;
        let rgb = "#", c, i;
        for (i = 0; i < 3; i++) {
            c = parseInt(hex.substr(i*2,2), 16);
            c = Math.round(Math.min(255, Math.max(0, c + (c * lum))));
            rgb += ("00"+c.toString(16)).substr(-2);
        }
        return rgb;
    }


    // --- UTILS (UI & Modals) ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

    function switchTab(id) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
        document.querySelector(`.nav-link[onclick*="${id}"]`).classList.add('active'); // Select by part of onclick
        document.getElementById(id).classList.add('active');
        const titles = { 'orders': 'Orders Management', 'products': 'Products Inventory', 'gallery': '3D Gallery Items', 'settings': 'Website Settings & Theme' };
        document.getElementById('page-title').innerText = titles[id];
    }

    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }

    function closeModal(id) { 
        document.getElementById(id).style.display='none'; 
        // Clear file inputs on modal close
        if (id === 'productModal') {
            document.getElementById('edit-file1').value = "";
            document.getElementById('edit-file2').value = "";
            document.getElementById('edit-file3').value = "";
        } else if (id === 'galleryModal') {
            document.getElementById('gal-file').value = "";
        }
    }

    // --- COMPLETED PREVIEW FILE FUNCTION ---
    function previewFile(input, id) {
        const box = document.getElementById(id);
        if (input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = function(e) {
                // If it's an image, show preview. If video, show text placeholder or basic video tag
                if(input.files[0].type.startsWith('video')) {
                    box.innerHTML = `<div style="font-size:12px; color:var(--primary);">Video Selected (${input.files[0].name})</div>`;
                } else {
                    box.innerHTML = `<img src="${e.target.result}" style="height:100%">`;
                }
                box.classList.add('has-file');
            }
            r.readAsDataURL(input.files[0]);
        }
    }
</script>
</body>
</html>

